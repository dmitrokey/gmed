<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmed Cosmetics PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
    
    .glass-header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
    
    .dropdown-content { 
        display: none; position: absolute; right: 0; top: 100%; 
        background: white; min-width: 220px; max-height: 380px; 
        overflow-y: auto; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); 
        border-radius: 1.25rem; z-index: 100; border: 1px solid #f1f5f9; padding: 8px;
    }
    .dropdown-content.show { display: block; }

    .opt-input { font-size: 11px !important; font-weight: 700 !important; }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    #pdf-template { display: none; padding: 30px; background: white; }

    /* ПРАВИЛЬНІ СТИЛІ ДЛЯ ОПИСУ */
.desc-wrapper {
    display: block; /* Додай це */
    position: relative;
    max-height: 2.8rem;
    overflow: hidden;
    transition: max-height 0.5s ease-in-out;
    white-space: pre-line;
}

    /* Клас, який додається скриптом при натисканні */
    .desc-wrapper.expanded {
        max-height: 2000px; /* Велика висота для розкриття */
        transition: max-height 0.8s ease-in;
    }

    /* Ефект затемнення тексту знизу */
    .desc-wrapper:not(.expanded)::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 15px;
        background: linear-gradient(transparent, white);
    }
</style>
</head>
<body class="pb-20">

<header class="glass-header sticky top-0 z-50 px-4 py-3">
    <div class="container mx-auto flex justify-between items-center">
        <img src="https://res.cloudinary.com/dtmvidhde/image/upload/v1770034516/Gmed_cosmetics_z7hp7a.jpg" class="h-10 rounded-lg shadow-sm">
        <div class="flex items-center gap-2">
            <button onclick="generatePDF()" class="w-10 h-10 flex items-center justify-center rounded-xl bg-blue-50 text-blue-600 shadow-sm" title="PDF Прайс">
                <i class="fas fa-file-pdf text-sm"></i>
            </button>
            <div class="relative">
                <button onclick="document.getElementById('catDropdown').classList.toggle('show')" class="px-5 py-2.5 bg-emerald-500 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-emerald-100">Категорії</button>
                <div id="catDropdown" class="dropdown-content mt-2"></div>
            </div>
            <button onclick="handleAuth()" id="adminBtn" class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-900 text-white shadow-lg">
                <i class="fas fa-lock text-xs"></i>
            </button>
        </div>
    </div>
</header>

<div id="adminPanel" class="hidden sticky top-[65px] z-40 bg-slate-900 text-white border-b border-emerald-500/30">
    <div class="container mx-auto px-4 py-2 flex flex-wrap items-center justify-between gap-4">
        <div class="flex items-center gap-3 bg-white/5 p-1 rounded-xl">
            <div class="flex flex-col items-center px-2 border-l border-white/10">
                <span class="text-[7px] text-emerald-400 uppercase">Спец №1</span>
                <input type="number" id="inputSpec1" step="0.1" class="w-12 bg-transparent text-xs font-bold text-center text-emerald-400 outline-none">
            </div>
            <div class="flex flex-col items-center px-2 border-l border-white/10">
                <span class="text-[7px] text-blue-400 uppercase">Спец №2</span>
                <input type="number" id="inputSpec2" step="0.1" class="w-12 bg-transparent text-xs font-bold text-center text-blue-400 outline-none">
            </div>
            <button onclick="saveRates()" class="bg-emerald-500 px-3 py-2 rounded-lg text-[9px] font-black uppercase">ОК</button>
        </div>
        <button onclick="openEditModal()" class="bg-blue-600 px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-wider">+ Додати товар</button>
    </div>
</div>

<main class="container mx-auto px-4 mt-8">
    <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
</main>

<div id="productModal" class="hidden fixed inset-0 z-[60] bg-black/70 backdrop-blur-sm flex items-center justify-center p-2">
    <div class="bg-white w-full max-w-md rounded-[2rem] overflow-hidden shadow-2xl flex flex-col max-h-[95vh]">
        <div class="h-24 bg-slate-50 flex items-center justify-center p-2 border-b shrink-0">
            <img id="modalPreview" src="" class="max-h-full object-contain">
        </div>

        <form id="productForm" class="p-5 space-y-3 overflow-y-auto">
            <input type="hidden" id="edit_id">
            <input type="text" id="f_name" placeholder="Назва товару" class="w-full bg-slate-100 rounded-xl p-3 text-sm font-bold outline-none">
            
            <textarea id="f_description" placeholder="Опис товару (склад, застосування...)" rows="3" class="w-full bg-slate-50 rounded-xl p-3 text-xs outline-none border border-slate-100 resize-none"></textarea>

            <div class="grid grid-cols-2 gap-2">
                <input type="text" id="f_category" placeholder="Бренд/Категорія" class="bg-slate-50 rounded-lg p-2 text-xs font-bold outline-none border border-slate-100">
                <input type="text" id="f_dosage" placeholder="Об'єм (напр. 50мл)" class="bg-slate-50 rounded-lg p-2 text-xs font-bold outline-none border border-slate-100">
            </div>

            <input type="text" id="f_image_url" oninput="document.getElementById('modalPreview').src=this.value" placeholder="URL зображення" class="w-full bg-slate-50 rounded-lg p-2 text-[10px] outline-none border border-slate-100">

            <div class="bg-emerald-50/50 p-3 rounded-xl border border-emerald-100 flex items-center gap-3">
                <div class="flex-grow">
                    <p class="text-[8px] font-black text-emerald-700 uppercase mb-1">Базова ціна</p>
                    <div class="flex gap-2">
                        <input type="number" id="f_price_base" step="0.01" class="w-full rounded-lg p-2 text-sm font-bold border-none shadow-sm">
                        <select id="f_currency" class="rounded-lg p-2 text-xs font-bold shadow-sm border-none"><option value="€">€</option><option value="грн">грн</option><option value="$">$</option></select>
                    </div>
                </div>
                <div class="w-28">
                    <p class="text-[7px] font-bold text-slate-500 uppercase mb-1 text-center">Тип курсу</p>
                    <select id="f_is_special_rate" class="w-full rounded-lg p-2 text-[10px] font-bold border-none shadow-sm bg-white">
    <option value="0">Без спецкурсу (номінал)</option>
    <option value="1">Спецкурс №1 (грн)</option>
    <option value="2">Спецкурс №2 (грн)</option>
</select>
                </div>
            </div>

            <div class="space-y-1">
                <p class="text-[8px] font-black text-slate-400 uppercase ml-1">Оптові умови</p>
                <div class="grid grid-cols-1 gap-1">
                    <div class="flex items-center gap-1 bg-slate-50 p-1 rounded-lg">
                        <input type="text" id="f_condition_2_val" placeholder="К-сть" class="opt-input w-12 p-2 rounded-md bg-white text-center">
                        <input type="text" id="f_condition_2_unit" placeholder="Од." class="opt-input w-12 p-2 rounded-md bg-white text-center">
                        <input type="number" id="f_price_2_usd_eur" step="0.01" placeholder="Ціна" class="opt-input flex-grow p-2 rounded-md bg-white text-center text-emerald-600">
                    </div>
                    <div class="flex items-center gap-1 bg-slate-50 p-1 rounded-lg">
                        <input type="text" id="f_condition_3_val" placeholder="К-сть" class="opt-input w-12 p-2 rounded-md bg-white text-center">
                        <input type="text" id="f_condition_3_unit" placeholder="Од." class="opt-input w-12 p-2 rounded-md bg-white text-center">
                        <input type="number" id="f_price_3_usd_eur" step="0.01" placeholder="Ціна" class="opt-input flex-grow p-2 rounded-md bg-white text-center text-emerald-600">
                    </div>
                    <div class="flex items-center gap-1 bg-slate-50 p-1 rounded-lg">
                        <input type="text" id="f_condition_4_val" placeholder="К-сть" class="opt-input w-12 p-2 rounded-md bg-white text-center">
                        <input type="text" id="f_condition_4_unit" placeholder="Од." class="opt-input w-12 p-2 rounded-md bg-white text-center">
                        <input type="number" id="f_price_4_usd_eur" step="0.01" placeholder="Ціна" class="opt-input flex-grow p-2 rounded-md bg-white text-center text-emerald-600">
                    </div>
                </div>
            </div>

            <div class="flex gap-2 pt-2 shrink-0">
                <button type="button" onclick="closeModal()" class="flex-1 bg-slate-100 text-slate-500 py-4 rounded-xl font-bold text-[9px] uppercase">Скасувати</button>
                <button type="button" onclick="saveProduct()" class="flex-[2] bg-slate-900 text-white py-4 rounded-xl font-black text-[9px] uppercase tracking-widest">Зберегти</button>
            </div>
        </form>
    </div>
</div>

<div id="pdf-template">
    <div style="text-align: center; border-bottom: 2px solid #10b981; padding-bottom: 20px; margin-bottom: 20px;">
        <h1 style="font-size: 28px; color: #0f172a; margin: 0;">GMED COSMETICS</h1>
        <p style="font-size: 12px; color: #64748b; margin-top: 5px;">Прайс-лист та каталог продукції</p>
    </div>
    <div id="pdf-list"></div>
</div>

<script>
    const SUPABASE_URL = 'https://djrrojucwvafgvetdrnf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqcnJvanVjd3ZhZmd2ZXRkcm5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2OTgwNjcsImV4cCI6MjA4NTI3NDA2N30.QLq_rJF6XwskKbOO3zjhSrF8DK3YnRscIIjJl0Kr2e4';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let allProducts = [];
let rates = { euro: 44.5, usd: 41.5, spec1: 45.0, spec2: 46.0 };
let currentFilter = 'Всі';

async function init() {
    const { data: settings } = await client.from('settings').select('*');
    if (settings) {
        const getV = (k) => settings.find(s => s.key === k)?.value;
        // Завантажуємо тільки потрібні спецкурси
        rates.spec1 = parseFloat(getV('spec1_rate')) || 45.0;
        rates.spec2 = parseFloat(getV('spec2_rate')) || 46.0;
    }
    
    // Відображаємо значення в адмінці (якщо вона видима)
    if (document.getElementById('inputSpec1')) {
        document.getElementById('inputSpec1').value = rates.spec1;
        document.getElementById('inputSpec2').value = rates.spec2;
    }

    const { data: { session } } = await client.auth.getSession();
    if (session) {
        document.getElementById('adminPanel').classList.remove('hidden');
        document.getElementById('adminBtn').innerHTML = '<i class="fas fa-sign-out-alt text-xs"></i>';
    }
    loadData();
}

    async function loadData() {
        const { data, error } = await client.from('products_2').select('*').order('sort_num', { ascending: true });
        if (data) { 
            allProducts = data;

allProducts.sort((a, b) => {
    if (a.category < b.category) return -1;
    if (a.category > b.category) return 1;
    return a.name.localeCompare(b.name, 'uk');
});

renderProducts(allProducts);
            renderCats(); 
        }
    }

   function formatPrice(p, amount) {
    if (!amount) return '—';
    
    const currencySign = p.currency === 'грн' ? '₴' : (p.currency || '€');

    // Якщо обрано Спец №1 (тип 1)
    if (p.is_special_rate === 1) {
        const uah = Math.round(amount * rates.spec1);
        return `${amount.toLocaleString()} ${currencySign} (${uah.toLocaleString()} ₴)`;
    } 
    
    // Якщо обрано Спец №2 (тип 2)
    if (p.is_special_rate === 2) {
        const uah = Math.round(amount * rates.spec2);
        return `${amount.toLocaleString()} ${currencySign} (${uah.toLocaleString()} ₴)`;
    }

    // Якщо спецкурсу немає (тип 0) — просто валюта
    return `${amount.toLocaleString()} ${currencySign}`;
}

    function renderProducts(products) {
    const isAdmin = !document.getElementById('adminPanel').classList.contains('hidden');
    document.getElementById('productsGrid').innerHTML = products.map(p => {
        let optHtml = '';
        [[p.condition_2_val, p.condition_2_unit, p.price_2_usd_eur],
         [p.condition_3_val, p.condition_3_unit, p.price_3_usd_eur],
         [p.condition_4_val, p.condition_4_unit, p.price_4_usd_eur]].forEach(s => {
            if (s[0] && s[2]) {
                optHtml += `
                <div class="flex justify-between items-center bg-slate-50 px-3 py-2 rounded-xl border border-slate-100 mb-1">
                    <span class="text-[9px] font-bold text-slate-400">${s[0] || ''} ${s[1] || ''}</span>
                    <span class="text-[9px] font-black text-emerald-600">${formatPrice(p, s[2])}</span>
                </div>`;
            }
        });

        return `
        <div class="bg-white rounded-[2.5rem] border border-slate-100 flex flex-col p-2 shadow-sm relative h-full">
            ${isAdmin ? `
            <div class="absolute top-4 right-4 z-10 flex flex-col gap-2">
                <button onclick="editById('${p.id}')" class="bg-white/90 backdrop-blur w-9 h-9 rounded-full shadow-md border flex items-center justify-center text-blue-600"><i class="fas fa-edit text-xs"></i></button>
                <button onclick="deleteP('${p.id}')" class="bg-red-500 w-9 h-9 rounded-full shadow-md flex items-center justify-center text-white"><i class="fas fa-trash-alt text-xs"></i></button>
            </div>` : ''}
            <div class="aspect-square p-6 flex items-center justify-center bg-slate-50/50 rounded-[2rem] mb-4">
                <img src="${p.image_url}" class="max-w-full max-h-full object-contain" loading="lazy">
            </div>
            <div class="px-4 pb-4 grow flex flex-col">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-[8px] font-black text-emerald-500 uppercase tracking-widest">${p.category || 'БРЕНД'}</span>
                    <span class="text-[8px] font-bold text-slate-300 uppercase">${p.dosage || ''}</span>
                </div>
                <h3 class="text-slate-900 text-[13px] font-bold leading-tight mb-2 min-h-[2.5rem] line-clamp-2">${p.name}</h3>
                <div class="mb-4 grow">
                    <div id="desc-${p.id}" class="desc-wrapper text-[10px] text-slate-500 italic leading-relaxed">
                        ${p.description || ''}
                    </div>
                    ${p.description && p.description.length > 60 ? `
                        <button onclick="window.toggleDescription('${p.id}', this)" class="mt-1 text-blue-600 text-[10px] font-extrabold uppercase tracking-tighter cursor-pointer relative z-20">Читати далі...</button>
                    ` : ''}
                </div>
                <div class="mt-auto">
                    <div class="text-xl font-black text-slate-900 mb-3">${formatPrice(p, p.price_base)}</div>
                    <div class="space-y-1">${optHtml}</div>
                    <a href="https://t.me/VikusyaGuzeeva" target="_blank" class="block w-full mt-4 py-3.5 bg-slate-900 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest text-center shadow-lg active:scale-95 transition-transform">Замовити</a>
                </div>
            </div>
        </div>`;
    }).join('');
}
    
window.editById = function(id) {
    const product = allProducts.find(p => p.id === id);
    if (product) openEditModal(product);
}

    function openEditModal(p = null) {
        document.getElementById('productForm').reset();
        document.getElementById('modalPreview').src = '';
        if (p) {
            document.getElementById('edit_id').value = p.id;
            document.getElementById('f_name').value = p.name || '';
            document.getElementById('f_description').value = p.description || '';
            document.getElementById('f_category').value = p.category || '';
            document.getElementById('f_dosage').value = p.dosage || '';
            document.getElementById('f_image_url').value = p.image_url || '';
            document.getElementById('f_price_base').value = p.price_base || '';
            document.getElementById('f_currency').value = p.currency || '€';
            document.getElementById('f_is_special_rate').value = p.is_special_rate || 0;
            for(let i=2; i<=4; i++) {
                document.getElementById(`f_condition_${i}_val`).value = p[`condition_${i}_val`] || '';
                document.getElementById(`f_condition_${i}_unit`).value = p[`condition_${i}_unit`] || '';
                document.getElementById(`f_price_${i}_usd_eur`).value = p[`price_${i}_usd_eur`] || '';
            }
            document.getElementById('modalPreview').src = p.image_url || '';
        } else {
            document.getElementById('edit_id').value = '';
        }
        document.getElementById('productModal').classList.remove('hidden');
    }

    async function saveProduct() {
        const id = document.getElementById('edit_id').value;
        const data = {
            name: document.getElementById('f_name').value,
            description: document.getElementById('f_description').value,
            category: document.getElementById('f_category').value,
            dosage: document.getElementById('f_dosage').value,
            image_url: document.getElementById('f_image_url').value,
            price_base: parseFloat(document.getElementById('f_price_base').value) || 0,
            currency: document.getElementById('f_currency').value,
            is_special_rate: parseInt(document.getElementById('f_is_special_rate').value),
            condition_2_val: document.getElementById('f_condition_2_val').value || null,
            condition_2_unit: document.getElementById('f_condition_2_unit').value || null,
            price_2_usd_eur: parseFloat(document.getElementById('f_price_2_usd_eur').value) || null,
            condition_3_val: document.getElementById('f_condition_3_val').value || null,
            condition_3_unit: document.getElementById('f_condition_3_unit').value || null,
            price_3_usd_eur: parseFloat(document.getElementById('f_price_3_usd_eur').value) || null,
            condition_4_val: document.getElementById('f_condition_4_val').value || null,
            condition_4_unit: document.getElementById('f_condition_4_unit').value || null,
            price_4_usd_eur: parseFloat(document.getElementById('f_price_4_usd_eur').value) || null
        };
        const { error } = id ? await client.from('products_2').update(data).eq('id', id) : await client.from('products_2').insert([data]);
        if (!error) { closeModal(); loadData(); } else { alert("Помилка збереження"); }
    }

    function closeModal() { document.getElementById('productModal').classList.add('hidden'); }

 async function saveRates() {
    const spec1Val = document.getElementById('inputSpec1').value;
    const spec2Val = document.getElementById('inputSpec2').value;

    const updates = [
        { key: 'spec1_rate', value: spec1Val.toString() },
        { key: 'spec2_rate', value: spec2Val.toString() }
    ];

    for (const u of updates) {
        await client.from('settings').upsert(u, { onConflict: 'key' });
    }
    
    // Оновлюємо локальні змінні відразу
    rates.spec1 = parseFloat(spec1Val);
    rates.spec2 = parseFloat(spec2Val);
    
    alert("Курси збережено!");
    loadData(); // Перемальовуємо товари з новими курсами
}

    async function deleteP(id) { if(confirm("Видалити товар?")) { await client.from('products_2').delete().eq('id', id); loadData(); } }

    function renderCats() {
        const cats = ['Всі', ...new Set(allProducts.map(p => p.category).filter(Boolean))];
        document.getElementById('catDropdown').innerHTML = cats.map(c => `
            <button onclick="filterByCat('${c}')" class="w-full text-left px-4 py-3 text-[10px] font-black uppercase hover:bg-slate-50 border-b border-slate-50 last:border-0">${c}</button>
        `).join('');
    }

    function filterByCat(cat) {
    currentFilter = cat;
    document.getElementById('catDropdown').classList.remove('show');
    renderProducts(
        cat === 'Всі'
            ? allProducts
            : allProducts.filter(p => p.category === cat)
    );
}

   

    async function handleAuth() {
        const { data: { session } } = await client.auth.getSession();
        if (session) {
            await client.auth.signOut();
            location.reload();
        } else {
            const email = prompt("Email:");
            const password = prompt("Пароль:");
            if (email && password) {
                const { error } = await client.auth.signInWithPassword({ email, password });
                if (error) alert("Помилка: " + error.message);
                else location.reload();
            }
        }
    }
    
function generatePDF() {
    const visible = currentFilter === 'Всі' ? allProducts : allProducts.filter(p => p.category === currentFilter);
    const printWindow = window.open('', '_blank');
    
    const categories = [...new Set(visible.map(p => p.category || 'Інше'))].sort();

    let html = `
    <html>
    <head>
        <title>Прайс GMED COSMETICS</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
            
            body { font-family: 'Inter', sans-serif; margin: 0; padding: 15px; color: #000; }
            
            table { 
                width: 100%; 
                border-collapse: collapse; 
                table-layout: auto; /* Дозволяємо браузеру самому визначати ширину */
            }
            
            th, td { 
                border: 1px solid #000; 
                padding: 6px 8px; 
                font-size: 11px; 
                vertical-align: middle;
            }

            /* Категорія - зелена плашка на всю ширину */
            .cat-header { 
                background-color: #92d050 !important; 
                font-weight: 700; 
                text-transform: uppercase;
                padding: 4px 10px;
            }
            
            /* Перша колонка отримує максимум місця */
            .col-info { text-align: left; }
            
            /* Колонки з фіксованим мінімальним вмістом */
            .col-unit { width: 60px; text-align: center; white-space: nowrap; }
            .col-img { width: 90px; text-align: center; }
            .col-prices { width: 180px; text-align: left; white-space: nowrap; }

            .product-name { font-weight: 700; font-size: 12px; }
            .cert-text { color: #38761d; font-weight: 500; }
            .product-desc { 
                font-size: 10px; 
                color: #333; 
                line-height: 1.2; 
                margin-top: 3px;
                display: block;
            }
            
            .img-preview { 
                max-width: 80px; 
                max-height: 70px; 
                object-fit: contain; 
                display: block; 
                margin: 0 auto; 
            }
            
            .price-entry { font-size: 10.5px; margin-bottom: 1px; font-weight: 500; }

            @media print {
                tr { page-break-inside: avoid; }
                .cat-header { -webkit-print-color-adjust: exact; background-color: #92d050 !important; }
            }
        </style>
    </head>
    <body>
        <table>
            ${categories.map(cat => `
                <tr><td colspan="4" class="cat-header">${cat}</td></tr>
                ${visible.filter(p => (p.category || 'Інше') === cat).map(p => {
                    
                    // Логіка цін (Гривня або Євро з конвертацією)
                    const getPriceLabel = (val, price) => {
                        if (!price) return "";
                        let formattedPrice = "";
                        if (p.is_special_rate) {
                            const rate = p.is_special_rate === 1 ? rates.spec1 : rates.spec2;
                            formattedPrice = `${price} € = ${Math.round(price * rate)} грн.`;
                        } else {
                            formattedPrice = `${price} грн.`;
                        }
                        return `<div class="price-entry">${val > 1 ? 'Від ' + val + ' шт. - ' : 'Від 1 шт. - '}${formattedPrice}</div>`;
                    };

                    let priceRows = getPriceLabel(1, p.price_base);
                    if (p.condition_2_val) priceRows += getPriceLabel(p.condition_2_val, p.price_2_usd_eur);
                    if (p.condition_3_val) priceRows += getPriceLabel(p.condition_3_val, p.price_3_usd_eur);
                    if (p.condition_4_val) priceRows += getPriceLabel(p.condition_4_val, p.price_4_usd_eur);

                    return `
                    <tr>
                        <td class="col-info">
                            <span class="product-name">${p.name}</span> 
                            <span class="cert-text">оригінал!!сертифікований в Україні</span>
                            <span class="product-desc">${p.description || ''}</span>
                        </td>
                        <td class="col-unit">${p.dosage || ''}</td>
                        <td class="col-img">
                            <img src="${p.image_url}" class="img-preview" onerror="this.style.display='none'">
                        </td>
                        <td class="col-prices">
                            ${priceRows}
                        </td>
                    </tr>`;
                }).join('')}
            `).join('')}
        </table>
    </body>
    </html>`;

    printWindow.document.write(html);
    printWindow.document.close();
    
    // Невелика затримка для завантаження картинок перед друком
    setTimeout(() => { printWindow.print(); }, 700);
}

window.toggleDescription = function(productId, buttonElement) {
    const descriptionBox = document.getElementById('desc-' + productId);
    if (descriptionBox) {
        const isNowExpanded = descriptionBox.classList.toggle('expanded');
        buttonElement.innerText = isNowExpanded ? 'Згорнути' : 'Читати далі...';
        
        if (!isNowExpanded) {
            // Повертаємо екран до картки товару, якщо опис був занадто довгим
            buttonElement.closest('.bg-white').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
};

window.filterByCategory = function(category) {
    let list = [...allProducts];

    if (category !== 'all') {
        list = list.filter(p => p.category === category);
    }

    list.sort((a, b) => {
        if (a.category < b.category) return -1;
        if (a.category > b.category) return 1;
        return a.name.localeCompare(b.name, 'uk');
    });

    renderProducts(list);
};


    init();


</script>
</body>
</html>
