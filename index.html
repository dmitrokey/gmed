<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmed Premium | Catalog</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; color: #1e293b; }
        .glass-header { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        
        /* Dropdown з прокруткою */
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            min-width: 260px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            border-radius: 1.5rem;
            padding: 0.5rem;
            z-index: 100;
            border: 1px solid #f1f5f9;
            scrollbar-width: thin;
        }
        .dropdown-content.show { display: block; }
        .dropdown-content::-webkit-scrollbar { width: 4px; }
        .dropdown-content::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        .cat-item {
            width: 100%; text-align: left; padding: 12px 20px; border-radius: 1rem;
            font-size: 13px; font-weight: 600; transition: all 0.2s;
        }
        .cat-item:hover { background: #f1f5f9; color: #10b981; }
        .cat-active { background: #1e293b !important; color: white !important; }

        .product-card { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .product-card:hover { transform: translateY(-8px); }

        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="pb-20">

<header class="glass-header sticky top-0 z-50 px-4 py-3 no-print">
    <div class="container mx-auto flex justify-between items-center">
        <div class="flex items-center gap-4">
            <img src="https://res.cloudinary.com/dtmvidhde/image/upload/v1770034516/Gmed_cosmetics_z7hp7a.jpg" 
                 class="h-10 w-auto rounded-lg shadow-sm" alt="Logo">
            <h1 class="hidden md:block font-extrabold tracking-tight text-slate-800 uppercase text-sm">GMED <span class="text-emerald-500">PRO</span></h1>
        </div>

        <div class="flex items-center gap-2">
            <button onclick="printPriceList()" class="p-2.5 bg-white border border-slate-200 rounded-xl text-red-500 hover:bg-red-50 transition-all shadow-sm">
                <i class="fas fa-file-pdf"></i>
            </button>
            
            <div class="relative">
                <button onclick="toggleDropdown()" class="flex items-center gap-2 px-4 py-2.5 bg-emerald-500 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-emerald-100">
                    <i class="fas fa-filter"></i> <span id="currentCatName">Категорії</span>
                </button>
                <div id="catDropdown" class="dropdown-content mt-2"></div>
            </div>

            <button onclick="toggleAdmin()" id="adminBtn" class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-900 text-white hover:bg-black shadow-lg transition-all">
                <i class="fas fa-lock text-xs"></i>
            </button>
        </div>
    </div>
</header>

<main class="container mx-auto px-4 mt-8 max-w-7xl">
    
    <div id="adminPanel" class="hidden mb-12 no-print animate-in fade-in slide-in-from-top-4 duration-500">
        <div class="bg-white rounded-[2.5rem] p-8 shadow-2xl border border-slate-100">
            
            <div class="mb-8 p-6 bg-slate-900 rounded-3xl text-white flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-emerald-500 rounded-full flex items-center justify-center shadow-lg">
                        <i class="fas fa-euro-sign text-xl text-white"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-black uppercase tracking-widest opacity-60">Поточний курс</p>
                        <p class="text-xl font-bold">1 € = <span id="displayRate">--</span> грн</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <input type="number" id="exchangeRateInput" step="0.1" placeholder="Курс" 
                           class="bg-white/10 border border-white/20 rounded-xl px-4 py-2 text-white outline-none focus:bg-white/20 w-32">
                    <button onclick="updateExchangeRate()" class="bg-emerald-500 hover:bg-emerald-400 px-6 py-2 rounded-xl font-bold transition-all">Оновити</button>
                </div>
            </div>

            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-slate-900 uppercase">Редактор товарів</h2>
                <button onclick="resetForm()" id="cancelBtn" class="hidden text-slate-400 hover:text-red-500"><i class="fas fa-times-circle text-2xl"></i></button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <input type="text" id="name" placeholder="Назва товару" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500">
                    <div id="editor" contenteditable="true" placeholder="Опис..." class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl min-h-[150px] outline-none"></div>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="price_text" placeholder="Ціна (цифра)" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl font-bold">
                        <input type="text" id="category" placeholder="Категорія" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl">
                    </div>
                    <input type="text" id="image_url" placeholder="URL зображення" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl">
                    <div class="flex items-center gap-3 p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                        <input type="checkbox" id="is_euro_special" class="w-5 h-5 accent-emerald-600 rounded">
                        <label for="is_euro_special" class="text-xs font-bold uppercase text-emerald-800">Це ціна в Євро (€)</label>
                    </div>
                    <button onclick="saveProduct()" id="saveBtn" class="w-full bg-slate-900 text-white p-5 rounded-2xl font-black uppercase tracking-widest hover:bg-emerald-600 transition-all shadow-xl">Зберегти товар</button>
                </div>
            </div>
            <input type="hidden" id="editId">
        </div>
    </div>

    <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        </div>
</main>

<script>
    const SUPABASE_URL = 'https://djrrojucwvafgvetdrnf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqcnJvanVjd3ZhZmd2ZXRkcm5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2OTgwNjcsImV4cCI6MjA4NTI3NDA2N30.QLq_rJF6XwskKbOO3zjhSrF8DK3YnRscIIjJl0Kr2e4';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let isAdminMode = false;
    let allProducts = [];
    let currentFilter = 'Всі';
    let currentEuroRate = localStorage.getItem('gmed_euro_rate') || 42.0;

    async function init() {
        const { data: { user } } = await client.auth.getUser();
        if (user) setAdminUI(true);
        loadData();

        window.onclick = (e) => {
            if (!e.target.closest('.relative')) document.getElementById("catDropdown").classList.remove("show");
        };
    }

    async function loadData() {
        const { data, error } = await client.from('products').select('*').order('created_at', { ascending: false });
        if (error) return;
        allProducts = data;
        renderDropdown();
        renderProducts(allProducts);
    }

    function toggleDropdown() { document.getElementById("catDropdown").classList.toggle("show"); }

    function renderDropdown() {
        const cats = ['Всі', ...new Set(allProducts.map(p => p.category).filter(Boolean))];
        const container = document.getElementById('catDropdown');
        container.innerHTML = cats.map(cat => `
            <button onclick="filterProducts('${cat}')" class="cat-item ${currentFilter === cat ? 'cat-active' : ''}">
                ${cat}
            </button>
        `).join('');
    }

    function filterProducts(cat) {
        currentFilter = cat;
        document.getElementById('currentCatName').innerText = cat;
        document.getElementById("catDropdown").classList.remove("show");
        renderDropdown();
        const filtered = cat === 'Всі' ? allProducts : allProducts.filter(p => p.category === cat);
        renderProducts(filtered);
    }

    function updateExchangeRate() {
        const newRate = document.getElementById('exchangeRateInput').value;
        if (newRate > 0) {
            currentEuroRate = newRate;
            localStorage.setItem('gmed_euro_rate', newRate);
            renderProducts(allProducts);
            alert("Курс оновлено до " + newRate);
        }
    }

    function renderProducts(products) {
        document.getElementById('displayRate').innerText = currentEuroRate;
        const grid = document.getElementById('productsGrid');
        grid.innerHTML = products.map(p => {
            let priceHTML = "";
            if (p.is_euro_special) {
                const uah = Math.round(parseFloat(p.price_text) * currentEuroRate);
                priceHTML = `${uah} <span class="text-[10px] text-slate-400 font-normal">грн (${p.price_text}€)</span>`;
            } else {
                priceHTML = `${p.price_text} <span class="text-[10px] text-slate-400 font-normal">грн</span>`;
            }

            return `
                <div class="product-card bg-white rounded-[2rem] overflow-hidden border border-slate-100 shadow-sm relative flex flex-col h-full group">
                    <div class="aspect-square bg-white p-6 flex items-center justify-center overflow-hidden">
                        <img src="${p.image_url || 'https://via.placeholder.com/400'}" 
                             class="max-w-full max-h-full object-contain group-hover:scale-110 transition-transform duration-700">
                    </div>
                    <div class="p-6 flex flex-col flex-grow">
                        <div class="text-[9px] font-black text-emerald-500 uppercase tracking-widest mb-1">${p.category || 'Gmed'}</div>
                        <h3 class="text-slate-900 text-sm font-bold leading-tight mb-4 flex-grow">${p.name}</h3>
                        <div class="mt-auto">
                            <div class="text-xl font-black text-slate-900 mb-4">${priceHTML}</div>
                            <a href="https://t.me/VikusyaGuzeeva" target="_blank" 
                               class="block w-full py-3 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest text-center hover:bg-emerald-600 transition-all shadow-lg shadow-slate-100">
                               Замовити
                            </a>
                        </div>
                    </div>
                    ${isAdminMode ? `
                        <div class="absolute top-3 right-3 flex flex-col gap-2">
                            <button onclick="prepareEdit('${p.id}')" class="w-8 h-8 bg-white/90 backdrop-blur shadow-sm rounded-full text-blue-600 flex items-center justify-center"><i class="fas fa-pen text-[10px]"></i></button>
                            <button onclick="deleteProduct('${p.id}')" class="w-8 h-8 bg-white/90 backdrop-blur shadow-sm rounded-full text-red-500 flex items-center justify-center"><i class="fas fa-trash text-[10px]"></i></button>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }

    async function saveProduct() {
        const id = document.getElementById('editId').value;
        const payload = {
            name: document.getElementById('name').value,
            description: document.getElementById('editor').innerHTML,
            price_text: document.getElementById('price_text').value,
            image_url: document.getElementById('image_url').value,
            category: document.getElementById('category').value || 'Інше',
            is_euro_special: document.getElementById('is_euro_special').checked
        };
        if (!payload.name || !payload.price_text) return alert("Назва та ціна обов'язкові!");
        const { error } = id ? await client.from('products').update(payload).eq('id', id) : await client.from('products').insert([payload]);
        if (error) alert(error.message); else location.reload();
    }

    function prepareEdit(id) {
        const p = allProducts.find(item => item.id == id);
        document.getElementById('editId').value = p.id;
        document.getElementById('name').value = p.name;
        document.getElementById('editor').innerHTML = p.description || '';
        document.getElementById('price_text').value = p.price_text;
        document.getElementById('image_url').value = p.image_url;
        document.getElementById('category').value = p.category;
        document.getElementById('is_euro_special').checked = p.is_euro_special;
        document.getElementById('adminPanel').classList.remove('hidden');
        document.getElementById('saveBtn').innerText = "Оновити";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function deleteProduct(id) {
        if (confirm("Видалити товар?")) { await client.from('products').delete().eq('id', id); loadData(); }
    }

    async function toggleAdmin() {
        if (isAdminMode) { await client.auth.signOut(); location.reload(); return; }
        const email = prompt("Email:");
        const pass = prompt("Pass:");
        const { error } = await client.auth.signInWithPassword({ email, password: pass });
        if (error) alert("Помилка"); else location.reload();
    }

    function setAdminUI(active) {
        isAdminMode = active;
        document.getElementById('adminPanel').classList.toggle('hidden', !active);
        document.getElementById('adminBtn').classList.toggle('bg-red-500', active);
    }

    function printPriceList() {
        const printWindow = window.open('', '_blank');
        const visible = currentFilter === 'Всі' ? allProducts : allProducts.filter(p => p.category === currentFilter);
        let html = `<html><head><style>body{font-family:sans-serif;padding:30px} table{width:100%;border-collapse:collapse} td,th{padding:10px;border-bottom:1px solid #eee;text-align:left} .price{text-align:right;font-weight:bold}</style></head><body>`;
        html += `<h2>GMED PRICELIST - ${currentFilter}</h2><table><tr><th>Товар</th><th>Ціна</th></tr>`;
        visible.forEach(p => { 
            const price = p.is_euro_special ? Math.round(p.price_text * currentEuroRate) + " грн" : p.price_text + " грн";
            html += `<tr><td>${p.name}</td><td class="price">${price}</td></tr>`; 
        });
        html += `</table></body></html>`;
        printWindow.document.write(html); printWindow.document.close(); printWindow.print();
    }

    init();
</script>
</body>
</html>
