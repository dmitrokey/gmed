<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmed Cosmetics PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
    
    .glass-header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
    
    .dropdown-content { 
        display: none; position: absolute; right: 0; top: 100%; 
        background: white; min-width: 220px; max-height: 380px; 
        overflow-y: auto; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); 
        border-radius: 1.25rem; z-index: 100; border: 1px solid #f1f5f9; padding: 8px;
    }
    .dropdown-content.show { display: block; }

    .opt-input { font-size: 11px !important; font-weight: 700 !important; }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    #pdf-template { display: none; padding: 30px; background: white; }

    /* –ü–†–ê–í–ò–õ–¨–ù–Ü –°–¢–ò–õ–Ü –î–õ–Ø –û–ü–ò–°–£ */
.desc-wrapper {
    display: block; /* –î–æ–¥–∞–π —Ü–µ */
    position: relative;
    max-height: 2.8rem;
    overflow: hidden;
    transition: max-height 0.5s ease-in-out;
    white-space: pre-line;
}

    /* –ö–ª–∞—Å, —è–∫–∏–π –¥–æ–¥–∞—î—Ç—å—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ */
    .desc-wrapper.expanded {
        max-height: 2000px; /* –í–µ–ª–∏–∫–∞ –≤–∏—Å–æ—Ç–∞ –¥–ª—è —Ä–æ–∑–∫—Ä–∏—Ç—Ç—è */
        transition: max-height 0.8s ease-in;
    }

    /* –ï—Ñ–µ–∫—Ç –∑–∞—Ç–µ–º–Ω–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –∑–Ω–∏–∑—É */
    .desc-wrapper:not(.expanded)::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 15px;
        background: linear-gradient(transparent, white);
    }
</style>
</head>
<body class="pb-20">

<header class="glass-header sticky top-0 z-50 px-4 py-3">
    <div class="container mx-auto flex justify-between items-center">
        <img src="https://res.cloudinary.com/dtmvidhde/image/upload/v1770034516/Gmed_cosmetics_z7hp7a.jpg" class="h-10 rounded-lg shadow-sm">
        <div class="flex items-center gap-2">
            <button id="pdfBtn" onclick="generatePDF()" class="w-10 h-10 flex items-center justify-center rounded-xl bg-blue-50 text-blue-600 shadow-sm hidden" title="PDF –ü—Ä–∞–π—Å">
    <i class="fas fa-file-pdf text-sm"></i>
</button>
            <div class="relative">
                <button onclick="document.getElementById('catDropdown').classList.toggle('show')" class="px-5 py-2.5 bg-emerald-500 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-emerald-100">–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó</button>
                <div id="catDropdown" class="dropdown-content mt-2"></div>
            </div>
            <button id="adminBtn" class="w-10 h-10 flex items-center justify-center rounded-xl bg-green-50 text-green-600 shadow-sm" title="–í—Ö—ñ–¥ –≤ –∞–¥–º—ñ–Ω—Ä–µ–∂–∏–º">
    <i class="fas fa-user-shield text-sm"></i> –í—Ö—ñ–¥
</button>

        </div>
    </div>
</header>

<div id="adminPanel" class="hidden sticky top-[65px] z-40 bg-slate-900 text-white border-b border-emerald-500/30">
    <div class="container mx-auto px-4 py-2 flex flex-wrap items-center justify-between gap-4">
        
        <div class="flex items-center gap-3 bg-white/5 p-1 rounded-xl">
            <div class="flex flex-col items-center px-2 border-l border-white/10">
                <span class="text-[7px] text-emerald-400 uppercase">–°–ø–µ—Ü ‚Ññ1</span>
                <input type="number" id="inputSpec1" step="0.1" class="w-12 bg-transparent text-xs font-bold text-center text-emerald-400 outline-none">
            </div>

            <div class="flex flex-col items-center px-2 border-l border-white/10">
                <span class="text-[7px] text-blue-400 uppercase">–°–ø–µ—Ü ‚Ññ2</span>
                <input type="number" id="inputSpec2" step="0.1" class="w-12 bg-transparent text-xs font-bold text-center text-blue-400 outline-none">
            </div>

            <button onclick="saveRates()" class="bg-emerald-500 px-3 py-2 rounded-lg text-[9px] font-black uppercase">
                –û–ö
            </button>
        </div>

        <div class="flex items-center gap-2">
            <span id="lastUpdated" class="text-[10px] text-emerald-400 hidden"></span>

            <button onclick="openEditModal()" class="bg-blue-600 px-4 py-2 rounded-xl">
                + –î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä
            </button>
        </div>

    </div>
</div>


<main class="container mx-auto px-4 mt-8">
    <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
</main>

<div id="productModal" class="hidden fixed inset-0 z-[60] bg-black/70 backdrop-blur-sm flex items-center justify-center p-2">
    <div class="bg-white w-full max-w-md rounded-[2rem] overflow-hidden shadow-2xl flex flex-col max-h-[95vh]">
        <div class="h-24 bg-slate-50 flex items-center justify-center p-2 border-b shrink-0">
            <img id="modalPreview" src="" class="max-h-full object-contain">
        </div>

        <form id="productForm" class="p-5 space-y-3 overflow-y-auto">
            <input type="hidden" id="edit_id">
            <input type="text" id="f_name" placeholder="–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É" class="w-full bg-slate-100 rounded-xl p-3 text-sm font-bold outline-none">
            
            <textarea id="f_description" placeholder="–û–ø–∏—Å —Ç–æ–≤–∞—Ä—É (—Å–∫–ª–∞–¥, –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è...)" rows="3" class="w-full bg-slate-50 rounded-xl p-3 text-xs outline-none border border-slate-100 resize-none"></textarea>

            <div class="grid grid-cols-2 gap-2">
                <input list="categoriesList" id="f_category" placeholder="–ö–∞—Ç–µ–≥–æ—Ä—ñ—è" class="bg-slate-50 rounded-lg p-2 text-xs font-bold outline-none border border-slate-100">

<datalist id="categoriesList">
    <!-- JS –±—É–¥–µ –¥–æ–¥–∞–≤–∞—Ç–∏ –æ–ø—Ü—ñ—ó —Å—é–¥–∏ -->
</datalist>

                <input type="text" id="f_dosage" placeholder="–û–¥–∏–Ω–∏—Ü—ñ —Ç–æ–≤–∞—Ä—É (—à—Ç., —É–ø. —à–ø—Ä.)" class="bg-slate-50 rounded-lg p-2 text-xs font-bold outline-none border border-slate-100">
            </div>
           <button type="button" onclick="openUploadWidget()" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-[10px] font-black">
        –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æ
    </button>

<button 
    type="button" 
    id="pasteBtn" 
    class="bg-indigo-600 text-white px-3 py-2 rounded-lg text-[10px] font-black transition-all duration-200">
    –í—Å—Ç–∞–≤–∏—Ç–∏ —Ñ–æ—Ç–æ
</button>
            <input type="text" id="f_image_url" oninput="document.getElementById('modalPreview').src=this.value" placeholder="URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è" class="w-full bg-slate-50 rounded-lg p-2 text-[10px] outline-none border border-slate-100">

            <div class="bg-emerald-50/50 p-3 rounded-xl border border-emerald-100 flex items-center gap-3">
                <div class="flex-grow">
                    <p class="text-[8px] font-black text-emerald-700 uppercase mb-1">–ë–∞–∑–æ–≤–∞ —Ü—ñ–Ω–∞</p>
                    <div class="flex gap-2">
                        <input type="number" id="f_price_base" step="0.01" class="w-full rounded-lg p-2 text-sm font-bold border-none shadow-sm">
                        <select id="f_currency" class="rounded-lg p-2 text-xs font-bold shadow-sm border-none"><option value="‚Ç¨">‚Ç¨</option><option value="–≥—Ä–Ω">–≥—Ä–Ω</option><option value="$">$</option></select>
                    </div>
                </div>
                <div class="w-28">
                    <p class="text-[7px] font-bold text-slate-500 uppercase mb-1 text-center">–¢–∏–ø –∫—É—Ä—Å—É</p>
                    <select id="f_is_special_rate" class="w-full rounded-lg p-2 text-[10px] font-bold border-none shadow-sm bg-white">
    <option value="0">–ë–µ–∑ —Å–ø–µ—Ü–∫—É—Ä—Å—É (–Ω–æ–º—ñ–Ω–∞–ª)</option>
    <option value="1">–°–ø–µ—Ü–∫—É—Ä—Å ‚Ññ1 (–≥—Ä–Ω)</option>
    <option value="2">–°–ø–µ—Ü–∫—É—Ä—Å ‚Ññ2 (–≥—Ä–Ω)</option>
</select>
                </div>
            </div>

            <div class="space-y-1">
                <p class="text-[8px] font-black text-slate-400 uppercase ml-1">–û–ø—Ç–æ–≤—ñ —É–º–æ–≤–∏</p>
                <div class="grid grid-cols-1 gap-1">
                    <div class="flex items-center gap-1 bg-slate-50 p-1 rounded-lg">
                        <input type="text" id="f_condition_2_val" placeholder="–ö-—Å—Ç—å" class="opt-input w-12 p-2 rounded-md bg-white text-center">
                        <input type="text" id="f_condition_2_unit" placeholder="–û–¥." class="opt-input w-12 p-2 rounded-md bg-white text-center">
                        <input type="number" id="f_price_2_usd_eur" step="0.01" placeholder="–¶—ñ–Ω–∞" class="opt-input flex-grow p-2 rounded-md bg-white text-center text-emerald-600">
                    </div>
                    <div class="flex items-center gap-1 bg-slate-50 p-1 rounded-lg">
                        <input type="text" id="f_condition_3_val" placeholder="–ö-—Å—Ç—å" class="opt-input w-12 p-2 rounded-md bg-white text-center">
                        <input type="text" id="f_condition_3_unit" placeholder="–û–¥." class="opt-input w-12 p-2 rounded-md bg-white text-center">
                        <input type="number" id="f_price_3_usd_eur" step="0.01" placeholder="–¶—ñ–Ω–∞" class="opt-input flex-grow p-2 rounded-md bg-white text-center text-emerald-600">
                    </div>
                    <div class="flex items-center gap-1 bg-slate-50 p-1 rounded-lg">
                        <input type="text" id="f_condition_4_val" placeholder="–ö-—Å—Ç—å" class="opt-input w-12 p-2 rounded-md bg-white text-center">
                        <input type="text" id="f_condition_4_unit" placeholder="–û–¥." class="opt-input w-12 p-2 rounded-md bg-white text-center">
                        <input type="number" id="f_price_4_usd_eur" step="0.01" placeholder="–¶—ñ–Ω–∞" class="opt-input flex-grow p-2 rounded-md bg-white text-center text-emerald-600">
                    </div>
                </div>
            </div>

            <div class="flex gap-2 pt-2 shrink-0">
                <button type="button" onclick="closeModal()" class="flex-1 bg-slate-100 text-slate-500 py-4 rounded-xl font-bold text-[9px] uppercase">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button type="button" onclick="saveProduct()" class="flex-[2] bg-slate-900 text-white py-4 rounded-xl font-black text-[9px] uppercase tracking-widest">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>
        </form>
    </div>
</div>

<div id="pdf-template">
    <div style="text-align: center; border-bottom: 2px solid #10b981; padding-bottom: 20px; margin-bottom: 20px;">
        <h1 style="font-size: 28px; color: #0f172a; margin: 0;">GMED COSMETICS</h1>
        <p style="font-size: 12px; color: #64748b; margin-top: 5px;">–ü—Ä–∞–π—Å-–ª–∏—Å—Ç —Ç–∞ –∫–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ–¥—É–∫—Ü—ñ—ó</p>
    </div>
    <div id="pdf-list"></div>
</div>

<script>
    const SUPABASE_URL = 'https://djrrojucwvafgvetdrnf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqcnJvanVjd3ZhZmd2ZXRkcm5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2OTgwNjcsImV4cCI6MjA4NTI3NDA2N30.QLq_rJF6XwskKbOO3zjhSrF8DK3YnRscIIjJl0Kr2e4';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
// --- –ö–Ω–æ–ø–∫–∞ PDF —Ç–∞ –∞–¥–º—ñ–Ω ---
const pdfBtn = document.getElementById('pdfBtn');
const adminBtn = document.getElementById('adminBtn');

adminBtn.addEventListener('click', handleAuth); // –ª–æ–≥—ñ–∫–∞ –≤—Ö–æ–¥—É/–≤–∏—Ö–æ–¥—É

async function updateUIForSession() {
    const { data: { session } } = await client.auth.getSession();

    if (session) {
        // –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —É–≤—ñ–π—à–æ–≤ ‚Üí –ø–æ–∫–∞–∑—É—î–º–æ –∞–¥–º—ñ–Ω–ø–∞–Ω–µ–ª—å —ñ PDF
        document.getElementById('adminPanel').classList.remove('hidden');

        // –ó–º—ñ–Ω—é—î–º–æ –∫–Ω–æ–ø–∫—É –∞–¥–º—ñ–Ω–∞ –Ω–∞ "–í–∏—Ö—ñ–¥"
        adminBtn.innerHTML = '<i class="fas fa-sign-out-alt text-xs"></i> –í–∏—Ö—ñ–¥';

        // –ü–æ–∫–∞–∑—É—î–º–æ PDF
        if (pdfBtn) pdfBtn.classList.remove('hidden');
    } else {
        // –ì—ñ—Å—Ç—å ‚Üí –ø—Ä–∏—Ö–æ–≤—É—î–º–æ PDF —ñ –∞–¥–º—ñ–Ω–ø–∞–Ω–µ–ª—å
        document.getElementById('adminPanel').classList.add('hidden');
        if (pdfBtn) pdfBtn.classList.add('hidden');

        // –ö–Ω–æ–ø–∫–∞ –∞–¥–º—ñ–Ω–∞ ‚Üí "–í—Ö—ñ–¥"
        adminBtn.innerHTML = '<i class="fas fa-user-shield text-sm"></i> –í—Ö—ñ–¥';
    }
}

// –í–∏–∫–ª–∏–∫–∞—î–º–æ –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏
updateUIForSession();


    let allProducts = [];
let rates = { euro: 44.5, usd: 41.5, spec1: 45.0, spec2: 46.0 };
let currentFilter = '–í—Å—ñ';

async function init() {
    const { data: settings } = await client.from('settings').select('*');
    if (settings) {
        const getV = (k) => settings.find(s => s.key === k)?.value;
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –ø–æ—Ç—Ä—ñ–±–Ω—ñ —Å–ø–µ—Ü–∫—É—Ä—Å–∏
        rates.spec1 = parseFloat(getV('spec1_rate')) || 45.0;
        rates.spec2 = parseFloat(getV('spec2_rate')) || 46.0;
    }
    
    // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –≤ –∞–¥–º—ñ–Ω—Ü—ñ (—è–∫—â–æ –≤–æ–Ω–∞ –≤–∏–¥–∏–º–∞)
    if (document.getElementById('inputSpec1')) {
        document.getElementById('inputSpec1').value = rates.spec1;
        document.getElementById('inputSpec2').value = rates.spec2;
    }

    const { data: { session } } = await client.auth.getSession();
    if (session) {
        document.getElementById('adminPanel').classList.remove('hidden');
        document.getElementById('adminBtn').innerHTML = '<i class="fas fa-sign-out-alt text-xs"></i>';
    }
    showLastUpdatedIfAdmin();
    loadData();
}

function populateCategoryDatalist() {
    const datalist = document.getElementById('categoriesList');
    const categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))].sort();
    
    datalist.innerHTML = categories.map(c => `<option value="${c}">`).join('');
}


    async function loadData() {
        const { data, error } = await client.from('products_2').select('*').order('sort_num', { ascending: true });
        if (data) { 
            allProducts = data;

allProducts.sort((a, b) => {
    if (a.category < b.category) return -1;
    if (a.category > b.category) return 1;
    return a.name.localeCompare(b.name, 'uk');
});

renderProducts(allProducts);
            renderCats(); 
            populateCategoryDatalist(); // <-- –î–æ–¥–∞—Ç–∏ —Ü–µ–π —Ä—è–¥–æ–∫
        }
    }

   function formatPrice(p, amount) {
    if (!amount) return '‚Äî';
    
    const currencySign = p.currency === '–≥—Ä–Ω' ? '‚Ç¥' : (p.currency || '‚Ç¨');

    // –Ø–∫—â–æ –æ–±—Ä–∞–Ω–æ –°–ø–µ—Ü ‚Ññ1 (—Ç–∏–ø 1)
    if (p.is_special_rate === 1) {
        const uah = Math.round(amount * rates.spec1);
        return `${amount.toLocaleString()} ${currencySign} (${uah.toLocaleString()} ‚Ç¥)`;
    } 
    
    // –Ø–∫—â–æ –æ–±—Ä–∞–Ω–æ –°–ø–µ—Ü ‚Ññ2 (—Ç–∏–ø 2)
    if (p.is_special_rate === 2) {
        const uah = Math.round(amount * rates.spec2);
        return `${amount.toLocaleString()} ${currencySign} (${uah.toLocaleString()} ‚Ç¥)`;
    }

    // –Ø–∫—â–æ —Å–ø–µ—Ü–∫—É—Ä—Å—É –Ω–µ–º–∞—î (—Ç–∏–ø 0) ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–∞–ª—é—Ç–∞
    return `${amount.toLocaleString()} ${currencySign}`;
}

    function renderProducts(products) {
    const isAdmin = !document.getElementById('adminPanel').classList.contains('hidden');
    document.getElementById('productsGrid').innerHTML = products.map(p => {
        let optHtml = '';
        [[p.condition_2_val, p.condition_2_unit, p.price_2_usd_eur],
         [p.condition_3_val, p.condition_3_unit, p.price_3_usd_eur],
         [p.condition_4_val, p.condition_4_unit, p.price_4_usd_eur]].forEach(s => {
            if (s[0] && s[2]) {
                optHtml += `
                <div class="flex justify-between items-center bg-slate-50 px-3 py-2 rounded-xl border border-slate-100 mb-1">
                    <span class="text-[9px] font-bold text-slate-400">${s[0] || ''} ${s[1] || ''}</span>
                    <span class="text-[9px] font-black text-emerald-600">${formatPrice(p, s[2])}</span>
                </div>`;
            }
        });

        return `
        <div class="bg-white rounded-[2.5rem] border border-slate-100 flex flex-col p-2 shadow-sm relative h-full">
            ${isAdmin ? `
<div class="absolute top-4 right-4 z-10 flex flex-col items-center gap-2">

    <button onclick="editById('${p.id}')" class="bg-white/90 backdrop-blur w-9 h-9 rounded-full shadow-md border flex items-center justify-center text-blue-600">
        <i class="fas fa-edit text-xs"></i>
    </button>
    <button onclick="deleteP('${p.id}')" class="bg-red-500 w-9 h-9 rounded-full shadow-md flex items-center justify-center text-white">
        <i class="fas fa-trash-alt text-xs"></i>
    </button>

    ${p.is_special_rate >= 1 ? (() => {
        const colors = {
            1: 'bg-emerald-400',
            2: 'bg-blue-500',
            3: 'bg-orange-500',
            4: 'bg-purple-500'
        };
        const colorClass = colors[p.is_special_rate] || 'bg-gray-500';
        return `
        <div class="w-9 h-9 mt-1 flex items-center justify-center ${colorClass} text-white rounded-full text-[10px] font-black shadow-md">
            –°–ö${p.is_special_rate}
        </div>
        `;
    })() : ''}

</div>` : ''}

            <div class="aspect-square p-6 flex items-center justify-center bg-slate-50/50 rounded-[2rem] mb-4">
                <img src="${p.image_url}" class="max-w-full max-h-full object-contain" loading="lazy">
            </div>
            <div class="px-4 pb-4 grow flex flex-col">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-[8px] font-black text-emerald-500 uppercase tracking-widest">${p.category || '–ë–†–ï–ù–î'}</span>
                    <span class="text-[8px] font-bold text-slate-300 uppercase">${p.dosage || ''}</span>
                </div>
                <h3 class="text-slate-900 text-[16px] font-bold leading-tight mb-2 min-h-[2.5rem] line-clamp-2">${p.name}</h3>
                <div class="mb-4 grow">
                    <div id="desc-${p.id}" class="desc-wrapper text-[10px] text-slate-500 italic leading-relaxed">
                        ${p.description || ''}
                    </div>
                    ${p.description && p.description.length > 60 ? `
                        <button onclick="window.toggleDescription('${p.id}', this)" class="mt-1 text-blue-600 text-[10px] font-extrabold uppercase tracking-tighter cursor-pointer relative z-20">–ß–∏—Ç–∞—Ç–∏ –¥–∞–ª—ñ...</button>
                    ` : ''}
                </div>
                <div class="mt-auto">
                    ${isAdmin ? `
    <div class="text-xl font-black text-slate-900 mb-3">${formatPrice(p, p.price_base)}</div>
    <div class="space-y-1">${optHtml}</div>
` : ''}

                   <a href="#" 
   onclick="orderProduct('${p.name}')" 
   class="block w-full mt-4 py-3.5 bg-blue-900 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest text-center shadow-lg active:scale-95 transition-transform">
   –ó–∞–º–æ–≤–∏—Ç–∏
</a>

                </div>
            </div>
        </div>`;
    }).join('');
}
    
window.editById = function(id) {
    const product = allProducts.find(p => p.id === id);
    if (product) openEditModal(product);
}

    function openEditModal(p = null) {
        document.getElementById('productForm').reset();
        document.getElementById('modalPreview').src = '';
        if (p) {
            document.getElementById('edit_id').value = p.id;
            document.getElementById('f_name').value = p.name || '';
            document.getElementById('f_description').value = p.description || '';
            document.getElementById('f_category').value = p.category || '';
            document.getElementById('f_dosage').value = p.dosage || '';
            document.getElementById('f_image_url').value = p.image_url || '';
            document.getElementById('f_price_base').value = p.price_base || '';
            document.getElementById('f_currency').value = p.currency || '‚Ç¨';
            document.getElementById('f_is_special_rate').value = p.is_special_rate || 0;
            for(let i=2; i<=4; i++) {
                document.getElementById(`f_condition_${i}_val`).value = p[`condition_${i}_val`] || '';
                document.getElementById(`f_condition_${i}_unit`).value = p[`condition_${i}_unit`] || '';
                document.getElementById(`f_price_${i}_usd_eur`).value = p[`price_${i}_usd_eur`] || '';
            }
            document.getElementById('modalPreview').src = p.image_url || '';
        } else {
            document.getElementById('edit_id').value = '';
        }
        document.getElementById('productModal').classList.remove('hidden');
    }

    async function saveProduct() {
        const id = document.getElementById('edit_id').value;
        const data = {
            name: document.getElementById('f_name').value,
            description: document.getElementById('f_description').value,
            category: document.getElementById('f_category').value,
            dosage: document.getElementById('f_dosage').value,
            image_url: document.getElementById('f_image_url').value,
            price_base: parseFloat(document.getElementById('f_price_base').value) || 0,
            currency: document.getElementById('f_currency').value,
            is_special_rate: parseInt(document.getElementById('f_is_special_rate').value),
            condition_2_val: document.getElementById('f_condition_2_val').value || null,
            condition_2_unit: document.getElementById('f_condition_2_unit').value || null,
            price_2_usd_eur: parseFloat(document.getElementById('f_price_2_usd_eur').value) || null,
            condition_3_val: document.getElementById('f_condition_3_val').value || null,
            condition_3_unit: document.getElementById('f_condition_3_unit').value || null,
            price_3_usd_eur: parseFloat(document.getElementById('f_price_3_usd_eur').value) || null,
            condition_4_val: document.getElementById('f_condition_4_val').value || null,
            condition_4_unit: document.getElementById('f_condition_4_unit').value || null,
            price_4_usd_eur: parseFloat(document.getElementById('f_price_4_usd_eur').value) || null
        };
        const { error } = id ? await client.from('products_2').update(data).eq('id', id) : await client.from('products_2').insert([data]);
        if (!error) { closeModal(); loadData(); } else { alert("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è"); }
    }

    function closeModal() { document.getElementById('productModal').classList.add('hidden'); }

 async function saveRates() {
    const spec1Val = document.getElementById('inputSpec1').value;
    const spec2Val = document.getElementById('inputSpec2').value;

    const updates = [
        { key: 'spec1_rate', value: spec1Val.toString() },
        { key: 'spec2_rate', value: spec2Val.toString() }
    ];

    for (const u of updates) {
        await client.from('settings').upsert(u, { onConflict: 'key' });
    }
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –ª–æ–∫–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ –≤—ñ–¥—Ä–∞–∑—É
    rates.spec1 = parseFloat(spec1Val);
    rates.spec2 = parseFloat(spec2Val);
    
    alert("–ö—É—Ä—Å–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!");
    loadData(); // –ü–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î–º–æ —Ç–æ–≤–∞—Ä–∏ –∑ –Ω–æ–≤–∏–º–∏ –∫—É—Ä—Å–∞–º–∏
}

    async function deleteP(id) { if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ–≤–∞—Ä?")) { await client.from('products_2').delete().eq('id', id); loadData(); } }

    function renderCats() {
        const cats = ['–í—Å—ñ', ...new Set(allProducts.map(p => p.category).filter(Boolean))];
        document.getElementById('catDropdown').innerHTML = cats.map(c => `
            <button onclick="filterByCat('${c}')" class="w-full text-left px-4 py-3 text-[10px] font-black uppercase hover:bg-slate-50 border-b border-slate-50 last:border-0">${c}</button>
        `).join('');
    }

    function filterByCat(cat) {
    currentFilter = cat;
    document.getElementById('catDropdown').classList.remove('show');
    renderProducts(
        cat === '–í—Å—ñ'
            ? allProducts
            : allProducts.filter(p => p.category === cat)
    );
}

   

    async function handleAuth() {
        const { data: { session } } = await client.auth.getSession();
        if (session) {
            await client.auth.signOut();
            location.reload();
        } else {
            const email = prompt("Email:");
            const password = prompt("–ü–∞—Ä–æ–ª—å:");
            if (email && password) {
                const { error } = await client.auth.signInWithPassword({ email, password });
                if (error) alert("–ü–æ–º–∏–ª–∫–∞: " + error.message);
                else location.reload();
            }
        }
    }
    
async function generatePDF() {
    const visible = currentFilter === '–í—Å—ñ' ? allProducts : allProducts.filter(p => p.category === currentFilter);
    const printWindow = window.open('', '_blank');
    
    const categories = [...new Set(visible.map(p => p.category || '–Ü–Ω—à–µ'))].sort();

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å
    const preloadImages = (products) => {
        return Promise.all(products.map(p => {
            return new Promise((resolve) => {
                if (!p.image_url) resolve();
                const img = new Image();
                img.src = p.image_url;
                img.onload = resolve;
                img.onerror = resolve; // –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —Ñ–æ—Ç–æ –±–∏—Ç–µ
            });
        }));
    };

    await preloadImages(visible);

    let html = `
    <html>
    <head>
        <title>–ü—Ä–∞–π—Å GMED</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
            body { font-family: 'Inter', sans-serif; margin: 0; padding: 10px; color: #000; }
            
            table { width: 100%; border-collapse: collapse; table-layout: auto; }
            th, td { border: 1px solid #000; padding: 6px; font-size: 11px; vertical-align: middle; }
            
            /* –°–µ–∫—Ü—ñ—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π —Ç–æ—á–Ω–æ —è–∫ –Ω–∞ —Ñ–æ—Ç–æ */
            .cat-header { 
                background: #92d050 !important; 
                font-weight: bold; 
                text-transform: uppercase; 
                padding: 4px 10px;
            }
            
            /* –ü–µ—Ä—à–∞ –∫–æ–ª–æ–Ω–∫–∞ ‚Äî –Ω–∞–π—à–∏—Ä—à–∞ */
            .col-info { width: auto; text-align: left; }
            /* –Ü–Ω—à—ñ ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ñ */
            .col-unit { width: 60px; text-align: center; white-space: nowrap; }
            .col-img { width: 85px; text-align: center; }
            .col-prices { width: 170px; text-align: left; line-height: 1.3; }

            .product-name { font-weight: bold; font-size: 12px; }
            .cert-label { color: #38761d; font-weight: bold; font-size: 11px; }
            .description { font-size: 10px; color: #333; display: block; margin-top: 2px; line-height: 1.2; }
            
            .prod-img { max-width: 80px; max-height: 65px; object-fit: contain; }
            
            .price-line { white-space: nowrap; font-size: 10.5px; margin-bottom: 1px; }

            @media print {
                tr { page-break-inside: avoid; }
                .cat-header { -webkit-print-color-adjust: exact; background-color: #92d050 !important; }
            }
        </style>
    </head>
    <body>
        <table>
            ${categories.map(cat => `
                <tr><td colspan="4" class="cat-header">${cat}</td></tr>
                ${visible.filter(p => (p.category || '–Ü–Ω—à–µ') === cat).map(p => {
                    
              // –¢–µ–ø–µ—Ä —Ç–æ—á–Ω–æ –¥—É–±–ª—é—î–º–æ —è–∫ –Ω–∞ —Å–∞–π—Ç—ñ, –Ω—ñ—á–æ–≥–æ –Ω–µ –¥–æ–¥–∞—î–º–æ –¥–æ–¥–∞—Ç–∫–æ–≤–æ
const formatPrice = (p, price, qty=null, unit=null) => {
    if (!price) return '';
    let amount = price;

    if (p.is_special_rate === 1) amount = Math.round(price * rates.spec1);
    else if (p.is_special_rate === 2) amount = Math.round(price * rates.spec2);

    const qtyText = qty ? `${qty}${unit ? ' ' + unit : ''}` : '';

    return `
        <div class="price-line">
            ${qtyText ? qtyText + ' ‚Äì ' : ''}
            ${price} ${p.currency || '–≥—Ä–Ω'}
            ${p.is_special_rate ? ` = ${amount} ‚Ç¥` : ''}
        </div>
    `;
};



               // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –∑ —Å–∞–π—Ç—É
let prices = formatPrice(p, p.price_base); // –±–∞–∑–æ–≤–∞ —Ü—ñ–Ω–∞
if (p.condition_2_val)
    prices += formatPrice(p, p.price_2_usd_eur, p.condition_2_val, p.condition_2_unit);

if (p.condition_3_val)
    prices += formatPrice(p, p.price_3_usd_eur, p.condition_3_val, p.condition_3_unit);

if (p.condition_4_val)
    prices += formatPrice(p, p.price_4_usd_eur, p.condition_4_val, p.condition_4_unit);


                    return `
                    <tr>
                        <td class="col-info">
                            <span class="product-name">${p.name}</span>
                            <span class="description">${p.description || ''}</span>
                        </td>
                        <td class="col-unit">${p.dosage || ''}</td>
                        <td class="col-img">
                            ${p.image_url ? `<img src="${p.image_url}" class="prod-img">` : ''}
                        </td>
                        <td class="col-prices">${prices}</td>
                    </tr>`;
                }).join('')}
            `).join('')}
        </table>
    </body>
    </html>`;

    printWindow.document.write(html);
    printWindow.document.close();
    
    // –î–∞—î–º–æ —â–µ 300–º—Å –Ω–∞ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π —Ä–µ–Ω–¥–µ—Ä –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    setTimeout(() => { printWindow.print(); }, 300);
}   

window.toggleDescription = function(productId, buttonElement) {
    const descriptionBox = document.getElementById('desc-' + productId);
    if (descriptionBox) {
        const isNowExpanded = descriptionBox.classList.toggle('expanded');
        buttonElement.innerText = isNowExpanded ? '–ó–≥–æ—Ä–Ω—É—Ç–∏' : '–ß–∏—Ç–∞—Ç–∏ –¥–∞–ª—ñ...';
        
        if (!isNowExpanded) {
            // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –µ–∫—Ä–∞–Ω –¥–æ –∫–∞—Ä—Ç–∫–∏ —Ç–æ–≤–∞—Ä—É, —è–∫—â–æ –æ–ø–∏—Å –±—É–≤ –∑–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–∏–º
            buttonElement.closest('.bg-white').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
};

window.filterByCategory = function(category) {
    let list = [...allProducts];

    if (category !== 'all') {
        list = list.filter(p => p.category === category);
    }

    list.sort((a, b) => {
        if (a.category < b.category) return -1;
        if (a.category > b.category) return 1;
        return a.name.localeCompare(b.name, 'uk');
    });

    renderProducts(list);
};


    init();
</script>

    
<!-- Cloudinary Widget -->
<script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
<script>
function openUploadWidget() {
    const widget = cloudinary.createUploadWidget({
        cloudName: 'dtmvidhde',
        uploadPreset: 'products_unsigned',
        cropping: true,                  // –æ–±—Ä—ñ–∑–∫–∞ —É–≤—ñ–º–∫–Ω–µ–Ω–∞, –∞–ª–µ –ø—Ä–∞—Ü—é—î —Ç—ñ–ª—å–∫–∏ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤
        croppingAspectRatio: 1,
        croppingCoordinatesMode: 'custom',
        multiple: false,
        folder: 'products',
        sources: ['local', 'url'],       // –¥–æ—Å—Ç—É–ø–Ω—ñ –æ–±–∏–¥–≤–∞ –≤–∞—Ä—ñ–∞–Ω—Ç–∏
        showAdvancedOptions: false,
        showCompletedButton: true
    }, (error, result) => {
        if (!error && result && result.event === "success") {
            const url = result.info.secure_url;
            document.getElementById('modalPreview').src = url;
            document.getElementById('f_image_url').value = url;
        } else if (error) {
            console.error("Upload Widget Error:", error);
        }
    });

    widget.open();
}
</script>

<script>
async function showLastUpdatedIfAdmin() {

    const isAdminVisible = !document
        .getElementById('adminPanel')
        .classList.contains('hidden');

    if (!isAdminVisible) return;


    // —è–∫—â–æ –∞–¥–º—ñ–Ω –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ localStorage ‚Äî –ø—Ä–∏–∫–ª–∞–¥:
    // if (localStorage.getItem("isAdmin") !== "true") return;

    try {
        const response = await fetch(
    "https://api.github.com/repos/dmitrokey/gmed/commits?per_page=1"
);

if (!response.ok) {
    console.error("GitHub API error:", response.status);
    return;
}

const data = await response.json();


        if (Array.isArray(data) && data.length > 0) {

            const dateStr = new Date(data[0].commit.committer.date);

            const formatted = dateStr.toLocaleString("uk-UA", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
                hour12: false
            });

            const el = document.getElementById("lastUpdated");
            el.textContent = "–û–Ω–æ–≤–ª–µ–Ω–æ: " + formatted;
            el.classList.remove("hidden");
        }

    } catch (error) {
        console.error("GitHub API error:", error);
    }
}


// === –í–°–¢–ê–í–ö–ê –ó–û–ë–†–ê–ñ–ï–ù–ù–Ø –ß–ï–†–ï–ó CTRL+V ===
document.addEventListener('paste', async function (event) {
    const items = event.clipboardData.items;

    for (let item of items) {
        if (item.type.indexOf("image") !== -1) {
            const blob = item.getAsFile();

            const formData = new FormData();
            formData.append("file", blob);
            formData.append("upload_preset", "products_unsigned"); // —Ç–≤—ñ–π preset

            try {
                const response = await fetch(
                    "https://api.cloudinary.com/v1_1/dtmvidhde/image/upload",
                    {
                        method: "POST",
                        body: formData
                    }
                );

                const data = await response.json();

                if (data.secure_url) {
                    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≤ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ –º–æ–¥–∞–ª–∫–∏
                    const preview = document.getElementById('modalPreview');
                    const input = document.getElementById('f_image_url');
                    preview.src = data.secure_url;
                    input.value = data.secure_url;
                }
            } catch (err) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è:", err);
            }
        }
    }
});

function orderProduct(productName) {
    const message = encodeURIComponent(`–í—ñ—Ç–∞—é, –±–∞–∂–∞—é –∑–∞–º–æ–≤–∏—Ç–∏: ${productName}`);
    const telegramUrl = `https://t.me/VikusyaGuzeeva?text=${message}`;
    window.open(telegramUrl, '_blank');
}

function uploadPastedImage(blob) {
    const formData = new FormData();
    formData.append("file", blob);
    formData.append("upload_preset", "products_unsigned");

    fetch("https://api.cloudinary.com/v1_1/dtmvidhde/image/upload", {
        method: "POST",
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.secure_url) {
            document.getElementById('modalPreview').src = data.secure_url;
            document.getElementById('f_image_url').value = data.secure_url;
        }
    })
    .catch(err => {
        console.error("–ü–æ–º–∏–ª–∫–∞ Cloudinary:", err);
        alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æ");
    });
}

document.getElementById("pasteBtn").addEventListener("click", async () => {
    try {
        // –ß–∏—Ç–∞—î–º–æ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É
        const items = await navigator.clipboard.read();

        for (const item of items) {
            for (const type of item.types) {
                if (type.startsWith("image/")) {
                    const blob = await item.getType(type);
                    uploadPastedImage(blob);
                    return;
                }
            }
        }
        alert("–£ –±—É—Ñ–µ—Ä—ñ –Ω–µ–º–∞—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è üòï");
    } catch (err) {
        console.error("–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É:", err);
        alert("–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –¥–æ–∑–≤–æ–ª–∏–≤ –¥–æ—Å—Ç—É–ø –¥–æ –±—É—Ñ–µ—Ä–∞ –æ–±–º—ñ–Ω—É");
    }
});

</script>

</body>
</html>
